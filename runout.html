<!DOCTYPE HTML>
<html>

<head>
  <style>
    body {
      margin: 0px;
      padding: 0px;
    }
  </style>

</head>

<body>
  <div id="ball_in_hand" />
  <div id="pool_table" style="float: left; width: 1150px;height:604px;">
    &nbsp;
    <img style="position:absolute" width="1100" height="604" src="http://corksandcleaver.com/v/2017/02/billiard-table-sizes-billiard-tables-billiards-table-dimensions-billiard-table-parts-billiard-table-felt-billiard-table-clearance-billiard-table-repair-carom-billiard-table-billiard-tables.png" />
    <canvas style="position:absolute; top: 45px; left: 50px" id="canvas" width="1050" height="550" z-index="-1" />
  </div>
  <div style="width: 300px; float: left">
    <div>Use left and right arrow keys to change turns.</div>
    <div>Remaining Difficulty: <span id="remaining_difficulty"></span></div>
    <div>Strength: <span id="strength"></span></div>
    <div>Spin: <span id="spin"></span></div>
  </div>
  <script src="game_data.js"></script>
  <script>
    document.onkeydown = checkKey;

    function checkKey(e) {
      e = e || window.event;

      if (e.keyCode == '37') {
        previous_turn();
      }
      else if (e.keyCode == '39') {
        next_turn();
      }
    }
    function Line(x1, y1, x2, y2) {
      this.x1 = x1;
      this.y1 = y1;
      this.x2 = x2;
      this.y2 = y2;
    }
    Line.prototype.drawWithArrowheads = function (ctx) {

      // arbitrary styling
      ctx.strokeStyle = "blue";
      ctx.fillStyle = "blue";
      ctx.lineWidth = 1;

      // draw the line
      ctx.beginPath();
      ctx.moveTo(this.x1, this.y1);
      ctx.lineTo(this.x2, this.y2);
      ctx.stroke();

      // draw the ending arrowhead
      var endRadians = Math.atan((this.y2 - this.y1) / (this.x2 - this.x1));
      endRadians += ((this.x2 > this.x1) ? 90 : -90) * Math.PI / 180;
      this.drawArrowhead(ctx, this.x2, this.y2, endRadians);


    }
    Line.prototype.drawArrowhead = function (ctx, x, y, radians) {
      ctx.save();
      ctx.beginPath();
      ctx.translate(x, y);
      ctx.rotate(radians);
      ctx.moveTo(0, 0);
      ctx.lineTo(5, 20);
      ctx.lineTo(-5, 20);
      ctx.closePath();
      ctx.restore();
      ctx.fill();
    }

    function convert_game_units_to_canvas_units(game_units) {
      return game_units * UNITS_PER_DIAMOND / game_data_units_per_diamond
    }

    function draw_line(context, start, end) {
      new Line(
        convert_game_units_to_canvas_units(start[1]) + 12,
        convert_game_units_to_canvas_units(start[0]) + BALL_OFFSET,
        convert_game_units_to_canvas_units(end[1]) + 12,
        convert_game_units_to_canvas_units(end[0]) + BALL_OFFSET)
        .drawWithArrowheads(context);
    }

    function render_img(context, img, x_in_diamonds, y_in_diamonds) {
      context.drawImage(
        img,
        convert_game_units_to_canvas_units(y_in_diamonds),
        convert_game_units_to_canvas_units(x_in_diamonds))
    }

    function add_to_sunk_object_balls(object_ball) {
      sunk_object_balls.add(object_ball)
    }

    function remove_from_sunk_object_balls(object_ball) {
      sunk_object_balls.delete(object_ball)
    }

    function next_turn() {
      if (current_turn == game_data["turns"].length - 1) {
        return
      }
      add_to_sunk_object_balls(game_data["turns"][current_turn]["object_ball_index"])
      current_turn += 1
      render_current_turn()
    }

    function previous_turn() {
      if (current_turn == 0) {
        return
      }
      current_turn -= 1
      remove_from_sunk_object_balls(game_data["turns"][current_turn]["object_ball_index"])
      render_current_turn()
    }

    function create_img(src) {
      let img = new Image()
      img.src = src

      promiseArray.push(
        new Promise(function (resolve, reject) {
          img.onload = function () {
            resolve();
          }
        }))
      return img
    }

    CANVAS_HEIGHT = 487
    CANVAS_WIDTH = 2 * CANVAS_HEIGHT
    UNITS_PER_DIAMOND = CANVAS_HEIGHT / 4
    BALL_OFFSET = 10

    let canvas = document.getElementById('canvas');
    let sunk_object_balls = new Set()

    let pockets = [
      [0, 0],
      [UNITS_PER_DIAMOND * 4, 0],
      [0, UNITS_PER_DIAMOND * 4],
      [UNITS_PER_DIAMOND * 4, UNITS_PER_DIAMOND * 4],
      [0, UNITS_PER_DIAMOND * 8],
      [UNITS_PER_DIAMOND * 4, UNITS_PER_DIAMOND * 8]
    ]

    var promiseArray = []

    let game_data_units_per_diamond = game_data["units_per_diamond"]
    let cue_ball_img = create_img(cue_ball_to_image())
    let eight_ball_img = create_img(eight_ball_to_image())
    let object_ball_imgs = []
    let opponent_object_ball_imgs = []
    for (let i = 0; i < game_data["object_balls"].length; ++i) {
      object_ball_imgs.push(create_img(object_ball_to_image(i)))
    }
    for (let i = 0; i < game_data["opponent_object_balls"].length; ++i) {
      opponent_object_ball_imgs.push(create_img(opponent_object_ball_to_image(i)))
    }

    Promise.all(promiseArray).then(imagesLoaded);

    function imagesLoaded() {
      render_current_turn()
    }

    let current_turn = 0
    function render_current_turn() {
      var context = canvas.getContext('2d')
      // clear
      context.clearRect(0, 0, canvas.width, canvas.height)

      let turn_data = game_data["turns"][current_turn]

      document.getElementById('strength').innerHTML = turn_data["strength"]
      document.getElementById('spin').innerHTML = turn_data["spin"]
      document.getElementById('remaining_difficulty').innerHTML = turn_data["runout_difficulty"]
      render_img(context, cue_ball_img, turn_data["cue_ball"][0], turn_data["cue_ball"][1])
      for (let i = 0; i < game_data["object_balls"].length; ++i) {
        if (sunk_object_balls.has(i)) {
          continue
        }
        render_img(
          context,
          object_ball_imgs[i],
          game_data["object_balls"][i][0],
          game_data["object_balls"][i][1])
      }
      for (let i = 0; i < game_data["opponent_object_balls"].length; ++i) {
        render_img(
          context,
          opponent_object_ball_imgs[i],
          game_data["opponent_object_balls"][i][0],
          game_data["opponent_object_balls"][i][1])
      }
      if (!sunk_object_balls.has(game_data["object_balls"].length)) {
        render_img(context, eight_ball_img, game_data["eight_ball"][0], game_data["eight_ball"][1])
      }
      draw_line(context, [0, 0], [4 * UNITS_PER_DIAMOND, 8 * UNITS_PER_DIAMOND])
      draw_line(context, turn_data["cue_ball"], turn_data["path"][0])
      for (let i = 0; i < turn_data["path"].length - 1; ++i) {
        draw_line(context, turn_data["path"][i], turn_data["path"][i + 1])
      }
    }

    function cue_ball_to_image() {
      return 'https://pad.chalkysticks.com//image/diagrammer/balls/chalkysticks/ball-cue.svg'
    }

    function opponent_object_ball_to_image(ball_index) {
      return 'https://pad.chalkysticks.com//image/diagrammer/balls/chalkysticks/ball-' + (ball_index + 9) + '.svg'
    }

    function eight_ball_to_image() {
      return 'https://pad.chalkysticks.com//image/diagrammer/balls/chalkysticks/ball-8.svg'
    }

    function object_ball_to_image(ball_index) {
      return 'https://pad.chalkysticks.com//image/diagrammer/balls/chalkysticks/ball-' + (ball_index + 1) + '.svg'
    }

    function Ball(x, y) {
      this.x = x;
      this.y = y;
    }
  </script>
</body>

</html>